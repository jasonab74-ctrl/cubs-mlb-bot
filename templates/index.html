<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Chicago Cubs — News & Feeds</title>
  <link rel="icon" href="/static/favicon.ico" />
  <link rel="stylesheet" href="/static/style.css"/>
</head>
<body>
  <header class="site-header">
    <div class="header-left">
      {% if logo_path %}
        <img class="team-logo" src="{{ url_for('static', filename=logo_path) }}" alt="logo"/>
      {% endif %}
      <div>
        <h1 class="title">{{ team }}</h1>
        <div class="updated">Updated:
          <span id="updatedLabel" data-ts="{{ '%.0f' % updated_ts }}"></span>
        </div>
      </div>
    </div>
    <div class="header-right">
      {% if audio_path %}
      <button id="songBtn" class="pill" title="Play clip">Cubs Win</button>
      <audio id="song" preload="auto">
        <source src="{{ url_for('static', filename=audio_path) }}" type="audio/mpeg"/>
      </audio>
      {% endif %}
    </div>
  </header>

  <nav class="links">
    {% if quick_links and quick_links|length > 0 %}
      <div class="pill-row">
        {% for l in quick_links %}
          <a class="pill" href="{{ l.url }}" target="_blank" rel="noopener">{{ l.name }}</a>
        {% endfor %}
      </div>
    {% endif %}
  </nav>

  {% if sources and sources|length > 0 %}
  <details class="sources-dd" open="false">
    <summary><span class="caret"></span> News Sources</summary>
    <ul class="source-list">
      {% for s in sources %}
        <li><a href="{{ s.url }}" target="_blank" rel="noopener">{{ s.name }}</a></li>
      {% endfor %}
    </ul>
  </details>
  {% endif %}

  <main id="feed" class="cards">
    {% if items and items|length > 0 %}
      {% for it in items %}
      <article class="card">
        <a class="card-title" href="{{ it.link }}" target="_blank" rel="noopener">
          {{ it.title }}
        </a>
        <div class="meta">
          <span class="source">{{ it.source or it.by }}</span>
          <span>•</span>
          <time data-ts="{{ '%.0f' % it.published_ts }}"></time>
        </div>
        {% if it.summary %}
        <p class="summary">{{ it.summary }}</p>
        {% endif %}
      </article>
      {% endfor %}
    {% else %}
      <div class="empty">No items yet. Run the collector to populate this.</div>
    {% endif %}
  </main>

  <div class="toolbar">
    <div id="newItemsBanner" class="banner hidden">New items available — <a href="#" id="reloadLink">refresh</a></div>
  </div>

  <script>
    function fmtTime(ts) {
      const d = new Date(ts * 1000);
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
      const dayMs = 86400000;
      const optsTime = { hour: 'numeric', minute: '2-digit' };
      const optsDay  = { month: 'short', day: 'numeric' };
      if (d.getTime() >= today) return `Today • ${d.toLocaleTimeString([], optsTime)}`;
      if (d.getTime() >= today - dayMs) return `Yesterday • ${d.toLocaleTimeString([], optsTime)}`;
      return `${d.toLocaleDateString([], optsDay)} • ${d.toLocaleTimeString([], optsTime)}`;
    }
    function hydrateTimes() {
      const up = document.getElementById('updatedLabel');
      if (up && up.dataset.ts) up.textContent = fmtTime(parseInt(up.dataset.ts, 10));
      document.querySelectorAll('time[data-ts]').forEach(t => t.textContent = fmtTime(parseInt(t.dataset.ts, 10)));
    }
    hydrateTimes(); setInterval(hydrateTimes, 60 * 1000);

    const POLL_MS = 5 * 60 * 1000;
    let lastCount = document.querySelectorAll('#feed .card').length;

    async function checkForUpdates() {
      try {
        const res = await fetch('/items.json', { cache: 'no-store' });
        const data = await res.json();
        const count = (data.items || []).length;
        if (count > lastCount) document.getElementById('newItemsBanner').classList.remove('hidden');
        const up = document.getElementById('updatedLabel');
        if (up && data.updated_ts) { up.dataset.ts = String(Math.floor(data.updated_ts)); hydrateTimes(); }
      } catch (e) {}
    }
    setInterval(checkForUpdates, POLL_MS);

    const song = document.getElementById('song');
    document.getElementById('songBtn')?.addEventListener('click', () => { if (!song) return; if (song.paused) song.play(); else song.pause(); });
    document.getElementById('reloadLink')?.addEventListener('click', (e) => { e.preventDefault(); window.location.reload(); });

    // rotate caret on details toggle
    const dd = document.querySelector('.sources-dd');
    const caret = document.querySelector('.sources-dd .caret');
    function syncCaret(){ if(!dd||!caret) return; caret.classList.toggle('open', dd.open); }
    dd?.addEventListener('toggle', syncCaret); syncCaret();
  </script>
</body>
</html>
